<?php

function school_dashboard_permission() {
  return array(
      'access school dashboard' => array(
        'title' => t('Access school dashboard'), 
        'description' => t('Allows teachers to access the school dashboard and see signed up students.'),
        ),
      );
}

function school_dashboard_block_info() {
	$blocks['menu'] = array(
		'info' => t('School dashboard - menu block'),
	);
	$blocks['recent-leavers'] = array(
		'info' => t('School dashboard - recent leavers'),
	);
	$blocks['summary-info'] = array(
		'info' => t('School dashboard - summary info'),
	);
	return $blocks;
}

function school_dashboard_block_view($delta = '') {
    civicrm_initialize();
    require_once 'CRM/Report/Form/Alumni/Alumni.php';
    $alumni_report = new CRM_Report_Form_Alumni_Alumni;
    $years = $alumni_report->getAlumniYears();
    $totalStudents = $alumni_report->getTotalStudents();
    
    switch ($delta){
        case 'menu':
		    $block['subject'] = 'School menu';
			$block['content'] = school_dashboard_menu_block($years);
			break;
        case 'recent-leavers':
	        $block['subject'] = 'Recent leavers';
			$block['content'] = school_dashboard_recent_leavers_block();
			break;
        case 'summary-info':
            $block['subject'] = 'Summary info';
			$block['content'] = school_dashboard_summary_info_block($totalStudents, $years);
			break;
	}
	return $block;			
}

function school_dashboard_recent_leavers_block(){
    drupal_add_js(drupal_get_path('module', 'school_dashboard').'/js/recent-leavers.js');
    return '<div id="recent_leavers"></div>';
}

function school_dashboard_summary_info_block($totalStudents, $years){
    $countYears=count($years);
    return "<p>You now have <span class='leavers'>{$totalStudents}</span> school leavers in <span class='years'>{$countYears}</span> different years.</b><p>";
}


function school_dashboard_menu_block($years){
    
    $output = '
    <ul>
        <li><a href="/school-dashboard">Dashboard</a></li>
        <li><a href="/school-dashboard/report">Search students</a></li>
        <li><a href="/school-dashboard/report?force=1&recent=1">Recent leavers</a></li>
        <li>Students by year</li>
        <ul>';
    
    foreach ($years as $year => $link){
        $output .= "<li><a href='/school-dashboard/report?force=1&year_value={$year}'>{$link}</a></li>";
    }
    $output .'    </ul>
        <li><a href="/school-dashboard/resources">Resources</a></li>
        <li><a href="/user/logout">Logout</a></li>
';
    return $output;
}


function school_dashboard_get_school_for_contact($contact_id){
    return 8123;
    $params[1]=array($contact_id, 'Integer');
    $sql="SELECT contact_id_b FROM civicrm_relationship AS cr WHERE cr.relationship_type_id=10 AND contact_id_a=%1";
    $result = CRM_Core_DAO::ExecuteQuery($params, $sql);
    $result->fetch();
}

// function school_dashboard_civicrm_aclGroup( $type, $contactID, $tableName, &$allGroups, &$currentGroups ){
// }

function school_dashboard_civicrm_aclWhereClause($type, &$tables, &$whereTables, &$contactID, &$where) {
    
    // $type - we only want to grant view and edit permissions
    if (($type != CRM_ACL_API::VIEW) and ($type != CRM_ACL_API::EDIT)) {
        return;
    }

    // if they are logged out, do not grant permissions
    if ( ! $contactID ) {
        return;
    }
    // try and get the teachers school
    $school = school_dashboard_get_school_for_contact($contactID);
    
    // if they don't have a school, don't grant permissions
    if(!$school){
        return;
    }

    $school_info_table='civicrm_value_contact_reference_9';
    $whereTables[$school_info_table] = "LEFT JOIN {$school_info_table} AS school_info_table ON contact_a.id = school_info_table.entity_id";
    $where .= "school_info_table.contact_reference_21 = {$school}";
}