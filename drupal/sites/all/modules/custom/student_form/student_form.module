<?php
// a block for displaying the school name

function student_form_menu(){
        $items['student-sign-up'] = array(
                'title' => 'Student sign up',
                'page callback' => 'student_form_list_page',
                'access arguments' => array('access content'),
                'type' => MENU_CALLBACK,
        );
	return $items;	
}

function student_form_theme(){
  return array(
      'student_form_list'=>array(
        'variables' => array('schools' => 'aNULL'),
        'template' => 'student-form-list'
        )
      );
}

function student_form_list_page(){
  civicrm_initialize();
  $query="
    SELECT
    school.organization_name AS school_name,
    school_cd.short_name_26 AS short_name,
    tag.id AS ark_tag
      FROM
      civicrm_contact AS school
      JOIN
      civicrm_value_school_1 AS school_cd ON school_cd.entity_id=school.id
      JOIN
      civicrm_membership AS mem ON school.id = mem.contact_id
      LEFT JOIN
      civicrm_entity_tag AS tag ON school.id=tag.entity_id AND tag_id=6
      ORDER BY school_name";
  $result = CRM_Core_DAO::executeQuery( $query );
  while($result->fetch()){
    $web_form_name = ($result->ark_tag) ? 'signup-ark' : 'signup';
    $schools[]=array('link'=>"{$web_form_name}/{$result->short_name}", 'name'=>$result->school_name);	
  }
  drupal_add_library('system', 'ui.autocomplete');
  drupal_add_js(drupal_get_path('module', 'student_form').'/js/student_form_autocomplete.js');
  drupal_add_css(drupal_get_path('module', 'civicrm').'/civicrm.css');
  return theme('student_form_list', array('schools' => $schools));
}

function student_form_block_info() {
	$blocks['info'] = array(
		'info' => t('School name'),
	);
	return $blocks;
}

function student_form_block_view($delta = '') {
	$block['subject'] = 'School name';
	$school = student_form_get_school();
	$block['content'] = $school['display_name'];
	return $block;
}

function student_form_get_school(){
	civicrm_initialize();
	$school_short_name = arg(2);
	if($school_short_name=='thekightstemplar'){
		drupal_goto('signup/theknightstemplar');
	}
	if(!strlen($school_short_name)){
		if(!strlen($_SESSION['student_form']['school_short_name'])){
			return FALSE;
		}else{
			$school_short_name = $_SESSION['student_form']['school_short_name'];
		}
	}	
	//query to see if the reference exists
	$sql = 'SELECT entity_id FROM civicrm_value_school_1 WHERE short_name_26=%1';
	$params[1] = array($school_short_name, 'String');
	$result = CRM_Core_DAO::executeQuery( $sql, $params);
	if(!$result->fetch()){
		return FALSE;
	};
	$contact_id = $result->entity_id;
	$params = array('version'=>3, 'id'=>$contact_id);
	$school = civicrm_api('Contact', 'getsingle', $params);
	return $school;

}
//function student_form_get_school_from_url(){}
function student_from_get_membership($contact_id){
	$membership_params = array (
		'version' =>'3',
		'contact_id' => $contact_id
	);
	$membership_result=civicrm_api("membership", "get", $membership_params);
	if($membership_result['count']==0){
		return FALSE;
	}else{
		return $membership_result;
	}
}

function student_form_node_view($node){
  global $user;
  if($node->nid==5 OR $node->nid==8 or $node->nid==14){
		drupal_add_js(drupal_get_path( 'module', 'student_form')."/js/webform-hide-fields-node-{$node->nid}.js" ); 
		$school = student_form_get_school();
		if(!$school){
			drupal_goto('signup/error');
		}elseif(!arg(2)){
			$signup_paths=array(5=>'signup-ark', 8=>'signup', 14=>'alumni');
			drupal_goto($signup_paths[$node->nid].'/'.$_SESSION['student_form']['school_short_name']);
		}
		$membership = student_from_get_membership($school['id']);
		if(!$school OR !is_array($membership)){
			drupal_goto('signup/error');
		}
    if(arg(2)){
      if($user->uid){
        //they are logged in on this page, i.e. they are a teacher - probably not a brilliant idea since they will overright their teacher record with a student record if they submit this form, so log them out.
        $redirect = $_SERVER['REQUEST_URI'];
        watchdog('user', 'Session closed for %name.', array('%name' => $user->name));
        module_invoke_all('user_logout', $user);
        session_destroy();
        drupal_set_message('You have been logged out so that students can fill in this form.');
        $_SESSION['student_form']['school_short_name'] = arg(2);
        drupal_goto($redirect);
      }
      $_SESSION['student_form']['school_short_name'] = arg(2);
    }
	}
}

function student_form_node_load($nodes, $types){
    
    //normal sign up form
	if(is_object($nodes[8])){
		$school = student_form_get_school();
		foreach ($nodes as $node){
			foreach($node->webform['components'] as $key => $component){
				if($component['form_key'] == 'civicrm_2_contact_1_contact_existing'){
					$node->webform['components'][$key]['value']=$school['id'];
				} 
			}
		}
	}
	
	//alumni sign up form
	if(is_object($nodes[14])){
		$school = student_form_get_school();
		foreach ($nodes as $node){
			foreach($node->webform['components'] as $key => $component){
				if($component['form_key'] == 'civicrm_5_contact_1_contact_existing'){
					$node->webform['components'][$key]['value']=$school['id'];
				} 
			}
		}
	}


	//ark sign up form
	if(is_object($nodes[5])){
		$school = student_form_get_school();
		foreach ($nodes as $node){
			foreach($node->webform['components'] as $key => $component){
				if($component['form_key'] == 'civicrm_2_contact_1_contact_existing'){
					$node->webform['components'][$key]['value']=$school['id'];
				} 
			}
		}
	}
}

	//alumni short form
	if(is_object($nodes[17])){
		$school = student_form_get_school();
		foreach ($nodes as $node){
			foreach($node->webform['components'] as $key => $component){
				if($component['form_key'] == 'civicrm_2_contact_1_contact_existing'){
					$node->webform['components'][$key]['value']=$school['id'];
				} 
			}
		}
	}
}